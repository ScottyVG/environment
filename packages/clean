#!/usr/bin/env bash
set -euo pipefail

LOG_FILE="/tmp/package-clean-$(date +%Y%m%d-%H%M%S).log"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log "ğŸ§¹ Starting package cleanup"
log "ğŸ“ Log file: $LOG_FILE"

# Find orphaned packages
orphaned=$(pacman -Qtdq 2>/dev/null || true)

if [[ -z "$orphaned" ]]; then
    log "âœ… No orphaned packages found. System is clean!"
    exit 0
fi

orphaned_count=$(echo "$orphaned" | wc -l)
log "ğŸ—‘ï¸  Found $orphaned_count orphaned packages:"

# Show orphaned packages with details
echo "$orphaned" | while read -r pkg; do
    if [[ -n "$pkg" ]]; then
        size=$(pacman -Qi "$pkg" 2>/dev/null | grep '^Installed Size' | cut -d: -f2- | sed 's/^ *//' || echo "Unknown")
        echo "  ğŸ“¦ $pkg ($size)"
    fi
done

echo ""
read -p "ğŸ—‘ï¸  Remove all orphaned packages? [y/N]: " confirm

case $confirm in
    [Yy]*)
        log "ğŸ—‘ï¸  Removing orphaned packages..."
        if echo "$orphaned" | sudo pacman -Rns - 2>&1 | tee -a "$LOG_FILE"; then
            log "âœ… Successfully removed orphaned packages"
        else
            log "âŒ Failed to remove some orphaned packages"
            exit 1
        fi
        ;;
    *)
        log "â­ï¸  Cleanup cancelled by user"
        ;;
esac

# Clean package cache
echo ""
read -p "ğŸ§¹ Clean package cache? [y/N]: " clean_cache

case $clean_cache in
    [Yy]*)
        log "ğŸ§¹ Cleaning package cache..."
        if sudo pacman -Sc --noconfirm 2>&1 | tee -a "$LOG_FILE"; then
            log "âœ… Package cache cleaned"
        else
            log "âŒ Failed to clean package cache"
        fi
        ;;
    *)
        log "â­ï¸  Cache cleaning skipped"
        ;;
esac

log "ğŸ‰ Cleanup completed. Log available at: $LOG_FILE"
